(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function t(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=t(o);fetch(o.href,s)}})();class ct{constructor(){this.currentStep=0,this.isActive=!1,this.overlay=null,this.highlightElement=null,this.skipButton=null,this.nextButton=null,this.prevButton=null,this.allowSkip=!0,this.autoAdvanceTimeout=null,this.originalAnimationState=null,this.originalKeyHandler=null,this.sidebarProtected=!1,this.steps=[{target:null,title:"Welcome to Spiral Animator",content:"Create beautiful animated spirals and explore the fascinating patterns hidden in prime numbers. Let's take a quick tour!",duration:0,position:"center",showControls:!0,actions:[]},{target:"#spiralCanvas",title:"The Spiral Canvas",content:"This is where the magic happens! Numbers are arranged in a spiral pattern, with prime numbers highlighted in bright green.",duration:0,position:"center",showControls:!0,actions:[]},{target:"#rotationToggle",title:"Rotation Control",content:"Control whether the entire spiral rotates continuously. Watch how it transforms the visual experience!",duration:0,position:"right",showControls:!0,actions:["highlight","demonstrate"]},{target:"#spiralSlider",title:"Spiral Coefficient",content:"This is the heart of the spiral! Adjust this slider to change how tightly the spiral winds. Small changes create dramatic effects.",duration:0,position:"right",showControls:!0,actions:["highlight","demonstrate"]},{target:"#spiralAnimationToggle",title:"Automatic Animation",content:"Let the spiral coefficient animate automatically for a mesmerizing, ever-changing display of mathematical beauty.",duration:0,position:"right",showControls:!0,actions:["highlight"]},{target:"#maxNSlider",title:"Point Density",content:"Control how many points are displayed. More points reveal greater detail but may impact performance on slower devices.",duration:0,position:"right",showControls:!0,actions:["highlight"]},{target:"#fullscreenToggle",title:"Immersive Experience",content:"Enter fullscreen mode for the most immersive mathematical journey. Perfect for presentations or deep exploration!",duration:0,position:"left",showControls:!0,actions:["highlight"]},{target:null,title:"Start Exploring!",content:"You're all set! Experiment with different settings, discover hidden patterns, and enjoy the mathematical beauty. You can always access this tutorial again from the help menu.",duration:0,position:"center",showControls:!0,actions:[]}],this.handleKeyPress=this.handleKeyPress.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this),this.nextStep=this.nextStep.bind(this),this.prevStep=this.prevStep.bind(this),this.skipTutorial=this.skipTutorial.bind(this)}async shouldShowTutorial(){const e=await this.getTutorialPreference("completed"),t=await this.getTutorialPreference("skipped"),n=await this.getTutorialPreference("manualTrigger");return!e&&!t||n}getTutorialPreference(e){if(!window.db)return Promise.resolve(null);try{const o=window.db.transaction(["preferences"],"readonly").objectStore("preferences").get(`tutorial_${e}`);return new Promise(s=>{o.onsuccess=()=>{var u;s(((u=o.result)==null?void 0:u.value)||null)},o.onerror=()=>s(null)})}catch(t){return console.warn("Failed to get tutorial preference:",t),Promise.resolve(null)}}saveTutorialPreference(e,t){if(!(!window.db||typeof window.savePreference!="function"))try{window.savePreference(`tutorial_${e}`,t)}catch(n){console.warn("Failed to save tutorial preference:",n)}}async start(e=!1){try{if(!e&&!await this.shouldShowTutorial())return;if(this.isActive){console.warn("Tutorial is already active");return}this.originalAnimationState={showClusters:window.showClusters,showRotation:window.showRotation,animateSpiralCoeff:window.animateSpiralCoeff},this.isActive=!0,this.currentStep=0,e&&this.saveTutorialPreference("manualTrigger",!1),this.createOverlay(),this.addEventListeners(),this.showStep(0),this.saveTutorialPreference("started",Date.now())}catch(t){console.error("Failed to start tutorial:",t),this.end()}}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="tutorial-overlay",this.overlay.setAttribute("role","dialog"),this.overlay.setAttribute("aria-modal","true"),this.overlay.setAttribute("aria-labelledby","tutorial-title"),this.overlay.setAttribute("aria-describedby","tutorial-description"),this.overlay.setAttribute("role","dialog"),this.overlay.setAttribute("aria-labelledby","tutorial-title"),this.overlay.setAttribute("aria-describedby","tutorial-content"),this.overlay.setAttribute("aria-modal","true");const e=document.createElement("div");e.className="tutorial-content";const t=document.createElement("div");t.className="tutorial-header";const n=document.createElement("h2");n.id="tutorial-title",n.className="tutorial-title";const o=document.createElement("button");o.className="tutorial-close",o.setAttribute("aria-label","Close tutorial"),o.textContent="×",t.appendChild(n),t.appendChild(o);const s=document.createElement("div");s.className="tutorial-body";const u=document.createElement("p");u.id="tutorial-content",u.className="tutorial-description",s.appendChild(u);const m=document.createElement("div");m.className="tutorial-footer";const l=document.createElement("div");l.className="tutorial-progress";const v=document.createElement("div");v.className="tutorial-progress-bar";const f=document.createElement("div");f.className="tutorial-progress-fill",v.appendChild(f);const w=document.createElement("span");w.className="tutorial-step-counter",w.setAttribute("aria-live","polite"),l.appendChild(v),l.appendChild(w);const y=document.createElement("div");y.className="tutorial-controls";const E=document.createElement("button");E.className="tutorial-btn tutorial-skip",E.textContent="Skip Tutorial",E.setAttribute("aria-label","Skip tutorial and close");const V=document.createElement("div");V.className="tutorial-nav";const D=document.createElement("button");D.className="tutorial-btn tutorial-prev",D.disabled=!0,D.textContent="Previous",D.setAttribute("aria-label","Go to previous tutorial step");const G=document.createElement("button");G.className="tutorial-btn tutorial-next tutorial-primary",G.textContent="Next",G.setAttribute("aria-label","Go to next tutorial step"),V.appendChild(D),V.appendChild(G),y.appendChild(E),y.appendChild(V),m.appendChild(l),m.appendChild(y),e.appendChild(t),e.appendChild(s),e.appendChild(m);const Q=document.createElement("div");Q.className="tutorial-spotlight",this.overlay.appendChild(e),this.overlay.appendChild(Q),document.body.appendChild(this.overlay),this.skipButton=this.overlay.querySelector(".tutorial-skip"),this.nextButton=this.overlay.querySelector(".tutorial-next"),this.prevButton=this.overlay.querySelector(".tutorial-prev");const rt=this.overlay.querySelector(".tutorial-close");this.skipButton.addEventListener("click",this.skipTutorial),this.nextButton.addEventListener("click",this.nextStep),this.prevButton.addEventListener("click",this.prevStep),rt.addEventListener("click",this.skipTutorial)}addEventListeners(){document.addEventListener("keydown",this.handleKeyPress),this.overlay.addEventListener("click",this.handleClickOutside),this.enableSidebarProtection(),this.setupFocusTrap()}setupFocusTrap(){const e=this.overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(e.length===0)return;const t=e[0],n=e[e.length-1];this.trapFocus=o=>{o.key==="Tab"&&(o.shiftKey?document.activeElement===t&&(o.preventDefault(),n.focus()):document.activeElement===n&&(o.preventDefault(),t.focus()))},document.addEventListener("keydown",this.trapFocus),setTimeout(()=>t.focus(),100)}removeEventListeners(){document.removeEventListener("keydown",this.handleKeyPress),this.overlay&&this.overlay.removeEventListener("click",this.handleClickOutside),this.disableSidebarProtection(),this.trapFocus&&(document.removeEventListener("keydown",this.trapFocus),this.trapFocus=null)}enableSidebarProtection(){if(this.sidebarProtected)return;this.sidebarProtected=!0,this.originalKeyHandler=document.onkeydown;const e=this;this.tutorialKeyHandlerAdded||(document.addEventListener("keydown",t=>{if(e.isActive&&t.key==="s"&&!t.ctrlKey&&!t.metaKey){const n=e.steps[e.currentStep];if(!n||n.target!=="#spiralCanvas")return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),e.showSidebarProtectionMessage(),!1}},{capture:!0,passive:!1}),this.tutorialKeyHandlerAdded=!0)}disableSidebarProtection(){this.sidebarProtected=!1}showSidebarProtectionMessage(){const e=document.createElement("div");e.className="tutorial-protection-toast",e.textContent="Sidebar is protected during tutorial - use tutorial controls to navigate",e.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 69, 0, 0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 3000;
      font-family: monospace;
      font-size: 14px;
      border: 2px solid #ff4500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    `,document.body.appendChild(e),setTimeout(()=>{e.style.opacity="1"},10),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300)},2e3)}handleKeyPress(e){if(this.isActive)switch(e.key){case"Escape":e.preventDefault(),this.skipTutorial();break;case"ArrowRight":case" ":e.preventDefault(),this.nextButton.disabled||this.nextStep();break;case"ArrowLeft":e.preventDefault(),this.prevButton.disabled||this.prevStep();break}}handleClickOutside(e){e.target===this.overlay&&this.currentStep<this.steps.length-1&&this.nextStep()}showStep(e){var o;if(e<0||e>=this.steps.length)return;const t=this.steps[e];this.currentStep=e,this.autoAdvanceTimeout&&(clearTimeout(this.autoAdvanceTimeout),this.autoAdvanceTimeout=null),this.manageSidebarVisibility(t),this.overlay.querySelector(".tutorial-title").textContent=t.title,this.overlay.querySelector(".tutorial-description").textContent=t.content;const n=(e+1)/this.steps.length*100;this.overlay.querySelector(".tutorial-progress-fill").style.width=`${n}%`,this.overlay.querySelector(".tutorial-step-counter").textContent=`${e+1} of ${this.steps.length}`,this.prevButton.disabled=e===0,this.nextButton.textContent=e===this.steps.length-1?"Finish":"Next",this.positionOverlay(t),this.highlightTarget(t.target),((o=t.actions)==null?void 0:o.length)>0&&this.performActions(t.actions,t.target),t.duration>0&&(this.autoAdvanceTimeout=setTimeout(()=>{this.currentStep<this.steps.length-1&&this.nextStep()},t.duration)),this.saveTutorialPreference(`step_${e}_viewed`,Date.now())}manageSidebarVisibility(e){const t=document.getElementById("sidebar");if(t&&e.target!=="#spiralCanvas"&&t.classList.contains("collapsed")){t.classList.remove("collapsed");const n=document.getElementById("sidebarToggle");n&&(n.textContent="✕",n.setAttribute("aria-expanded","true")),window.savePreference&&window.savePreference("sidebarCollapsed",!1)}}positionOverlay(e){const t=this.overlay.querySelector(".tutorial-content");if(!e.target||e.position==="center"){t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.maxWidth="500px",t.style.width="90vw";return}const n=document.querySelector(e.target);if(!n){t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)";return}const o=n.getBoundingClientRect(),s=window.innerWidth,u=window.innerHeight;switch(t.style.position="fixed",t.style.transform="none",t.style.maxWidth="400px",t.style.width="auto",e.position){case"right":o.right+420<s?(t.style.left=`${o.right+20}px`,t.style.top=`${Math.max(20,o.top)}px`):(t.style.right=`${s-o.left+20}px`,t.style.top=`${Math.max(20,o.top)}px`);break;case"left":o.left-420>0?(t.style.right=`${s-o.left+20}px`,t.style.top=`${Math.max(20,o.top)}px`):(t.style.left=`${o.right+20}px`,t.style.top=`${Math.max(20,o.top)}px`);break;case"top":t.style.left=`${Math.max(20,o.left)}px`,t.style.bottom=`${u-o.top+20}px`;break;case"bottom":t.style.left=`${Math.max(20,o.left)}px`,t.style.top=`${o.bottom+20}px`;break;default:t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)"}}highlightTarget(e){this.highlightElement&&this.highlightElement.classList.remove("tutorial-highlighted");const t=this.overlay.querySelector(".tutorial-spotlight");if(!e){t.style.display="none",this.highlightElement=null;return}const n=document.querySelector(e);if(!n){t.style.display="none",this.highlightElement=null;return}n.classList.add("tutorial-highlighted"),this.highlightElement=n;const o=n.getBoundingClientRect(),s=10;t.style.display="block",t.style.left=`${o.left-s}px`,t.style.top=`${o.top-s}px`,t.style.width=`${o.width+s*2}px`,t.style.height=`${o.height+s*2}px`}performActions(e,t){e.forEach((n,o)=>{setTimeout(()=>{switch(n){case"highlight":this.pulseHighlight(t);break;case"demonstrate":this.demonstrateControl(t);break}},o*1e3)})}pulseHighlight(e){const t=document.querySelector(e);t&&(t.style.animation="tutorial-pulse 2s ease-in-out 3")}demonstrateControl(e){switch(e){case"#spiralSlider":this.demonstrateSlider("#spiralSlider","#spiralNumber");break;case"#rotationToggle":this.demonstrateToggle("#rotationToggle");break}}demonstrateSlider(e,t){const n=document.querySelector(e),o=document.querySelector(t);if(!n)return;const s=parseFloat(n.value);parseFloat(n.min);const u=parseFloat(n.max),m=Math.min(s*1.5,u);setTimeout(()=>{n.value=m,o&&(o.value=m),n.dispatchEvent(new Event("input",{bubbles:!0}))},500),setTimeout(()=>{n.value=m+.1,o&&(o.value=m+.1),n.dispatchEvent(new Event("input",{bubbles:!0}))},800),setTimeout(()=>{n.value=m+.2,o&&(o.value=m+.2),n.dispatchEvent(new Event("input",{bubbles:!0}))},1100),setTimeout(()=>{n.value=m+.3,o&&(o.value=m+.3),n.dispatchEvent(new Event("input",{bubbles:!0}))},1400),setTimeout(()=>{n.value=m+.3,o&&(o.value=m+.3),n.dispatchEvent(new Event("input",{bubbles:!0}))},1700),setTimeout(()=>{n.value=m+.3,o&&(o.value=m+.3),n.dispatchEvent(new Event("input",{bubbles:!0}))},2e3),setTimeout(()=>{n.value=s,o&&(o.value=s),n.dispatchEvent(new Event("input",{bubbles:!0}))},2500)}demonstrateToggle(e){const t=document.querySelector(e);t&&(setTimeout(()=>{t.click()},500),setTimeout(()=>{t.click()},2e3))}nextStep(){this.currentStep<this.steps.length-1?this.showStep(this.currentStep+1):this.completeTutorial()}prevStep(){this.currentStep>0&&this.showStep(this.currentStep-1)}skipTutorial(){this.saveTutorialPreference("skipped",Date.now()),this.saveTutorialPreference("skipped_step",this.currentStep),this.saveTutorialPreference("manualTrigger",!1),console.log("Tutorial skipped at step",this.currentStep),this.end()}completeTutorial(){this.saveTutorialPreference("completed",Date.now()),this.saveTutorialPreference("completed_step",this.steps.length),this.saveTutorialPreference("manualTrigger",!1),console.log("Tutorial completed successfully"),this.end()}end(){this.isActive=!1,this.autoAdvanceTimeout&&(clearTimeout(this.autoAdvanceTimeout),this.autoAdvanceTimeout=null),this.highlightElement&&(this.highlightElement.classList.remove("tutorial-highlighted"),this.highlightElement=null),document.querySelectorAll(".tutorial-highlighted").forEach(t=>{t.classList.remove("tutorial-highlighted")}),this.overlay&&(this.overlay.classList.add("tutorial-fade-out"),setTimeout(()=>{this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null},300)),this.removeEventListeners(),this.originalAnimationState&&(this.originalAnimationState=null),this.saveTutorialPreference("manualTrigger",!1);const e=document.getElementById("spiralCanvas");e&&e.focus()}async isCompleted(){return await this.getTutorialPreference("completed")!==null}async hasBeenSkipped(){return!!await this.getTutorialPreference("skipped")}async hasBeenCompleted(){return!!await this.getTutorialPreference("completed")}async resetTutorialState(){this.saveTutorialPreference("skipped",null),this.saveTutorialPreference("completed",null),this.saveTutorialPreference("manualTrigger",null),this.saveTutorialPreference("started",null),this.saveTutorialPreference("skipped_step",null),this.saveTutorialPreference("completed_step",null),console.log("Tutorial state has been reset")}reset(){["completed","started","skipped","completed_step","manualTrigger"].forEach(t=>{this.saveTutorialPreference(t,null)});for(let t=0;t<this.steps.length;t++)this.saveTutorialPreference(`step_${t}_viewed`,null)}forceReset(){if(window.db)try{const t=window.db.transaction(["preferences"],"readwrite").objectStore("preferences"),n=t.getAllKeys();n.onsuccess=()=>{n.result.forEach(s=>{s.startsWith("tutorial_")&&t.delete(s)})}}catch(e){console.warn("Failed to force reset tutorial:",e)}}async getStats(){const e={completed:await this.getTutorialPreference("completed"),started:await this.getTutorialPreference("started"),skipped:await this.getTutorialPreference("skipped"),completedStep:await this.getTutorialPreference("completed_step"),stepViews:{}};for(let t=0;t<this.steps.length;t++){const n=await this.getTutorialPreference(`step_${t}_viewed`);n&&(e.stepViews[t]=n)}return e}async triggerManually(){try{this.saveTutorialPreference("manualTrigger",!0),await new Promise(e=>setTimeout(e,50)),await this.start(!0)}catch(e){console.error("Failed to manually trigger tutorial:",e)}}}class he{static sanitizeText(e){if(typeof e!="string")return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}static validateNumber(e,t,n,o){const s=Number(e);return isNaN(s)||s<t||s>n?o:s}static createRateLimiter(e,t){const n=[];return function(){const o=Date.now();for(;n.length>0&&n[0]<o-t;)n.shift();return n.length>=e?!1:(n.push(o),!0)}}}const Re=he.createRateLimiter(100,1e3),ut=he.createRateLimiter(5,1e3);typeof requestIdleCallback>"u"&&(window.requestIdleCallback=function(i){const e=Date.now();return setTimeout(function(){i({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-e))}})},1)});typeof cancelIdleCallback>"u"&&(window.cancelIdleCallback=function(i){clearTimeout(i)});const C=document.getElementById("spiralCanvas"),S=C.getContext("2d");let ie=5,k=5e3,r=2,q=[],F=!0,P=!0,A=!0,H=.1,ke=0,M=!1,j=.1,O=10,g=!1,b=!1,we=!0,h=!1,x=!0,p=null,I=!1,W=100,N=.1,c=1,d=500,Be=1,ge=null,_=null,be=!1;const dt=2e3;let K=100;const ye=200,mt=1,pt=10,ft=.25,Ee=[];function gt(){be||(document.body.style.cursor="none",be=!0)}function Te(){be&&(document.body.style.cursor="default",be=!1)}function te(){_&&clearTimeout(_),Te(),g&&(_=setTimeout(gt,dt))}function R(i,e=!1){const t=document.getElementById(e?"errorAnnouncements":"statusAnnouncements");t&&(t.textContent=i,setTimeout(()=>{t.textContent=""},1e3))}function ht(){const i=document.getElementById("currentSpiralValue"),e=document.getElementById("currentPointCount");i&&(i.textContent=r.toFixed(1)),e&&(e.textContent=k.toLocaleString())}function vt(){const i=document.getElementById("spiralCanvas");i&&i.addEventListener("keydown",e=>{if(!(e.target.tagName==="INPUT"||e.target.tagName==="TEXTAREA"))switch(e.key){case"ArrowUp":e.preventDefault();const t=parseFloat(document.getElementById("spiralNumber").value),n=Math.min(2e3,t+.5);document.getElementById("spiralSlider").value=n,document.getElementById("spiralNumber").value=n,r=n,B(),R(`Spiral coefficient increased to ${n.toFixed(1)}`);break;case"ArrowDown":e.preventDefault();const o=parseFloat(document.getElementById("spiralNumber").value),s=Math.max(.1,o-.5);document.getElementById("spiralSlider").value=s,document.getElementById("spiralNumber").value=s,r=s,B(),R(`Spiral coefficient decreased to ${s.toFixed(1)}`);break;case"Enter":case" ":e.preventDefault(),R(`Current spiral shows ${k} points with coefficient ${r.toFixed(1)}. Prime numbers are ${F?"highlighted":"not highlighted"}. Rotation is ${A?"active":"inactive"}.`);break}})}let z=null;function se(i){return window.matchMedia("(hover: none) and (pointer: coarse)").matches?i.replace(/Press ESC/g,"Tap ✕ at the top-right of this screen").replace(/ESC to/g,"Tap ✕ at the top-right of this screen to").replace(/or ESC/g,"or tap ✕ at the top-right of this screen"):i}function Ae(){const i=document.getElementById("fullscreenToast");i.classList.add("show"),z&&clearTimeout(z),z=setTimeout(()=>{i.classList.remove("show")},3e3)}async function Fe(){if(!ut()){console.warn("Fullscreen rate limit exceeded");return}if(window.__TAURI__)try{await window.__TAURI__.window.getCurrentWindow().setFullscreen(!0)}catch(i){console.error("Failed to enter fullscreen:",i)}else{const i=document.documentElement;try{i.requestFullscreen?await i.requestFullscreen():i.webkitRequestFullscreen?await i.webkitRequestFullscreen():i.msRequestFullscreen&&await i.msRequestFullscreen()}catch(e){console.error("Failed to enter fullscreen:",e)}}te()}async function ae(){if(_&&(clearTimeout(_),_=null),Te(),window.__TAURI__)try{await window.__TAURI__.window.getCurrentWindow().setFullscreen(!1)}catch(i){console.error("Failed to exit fullscreen:",i)}else try{document.exitFullscreen?await document.exitFullscreen():document.webkitExitFullscreen?await document.webkitExitFullscreen():document.msExitFullscreen&&await document.msExitFullscreen()}catch(i){console.error("Failed to exit fullscreen:",i)}}async function ne(){console.log("Showing interface in fullscreen mode");const i=document.getElementById("sidebar"),e=document.getElementById("sidebarToggle"),t=document.getElementById("fullscreenToggle");i.style.display="flex",e.style.display="flex",t.style.display="flex",_&&(clearTimeout(_),_=null),Te();const n=document.getElementById("fullscreenToast");n.textContent=se("Interface restored - Use macOS fullscreen controls to exit, or ESC to hide interface"),n.classList.add("show"),z&&clearTimeout(z),z=setTimeout(()=>{n.classList.remove("show"),n.textContent=se("Press ESC to exit fullscreen")},4e3)}function oe(){console.log("Hiding interface in fullscreen mode");const i=document.getElementById("sidebar"),e=document.getElementById("sidebarToggle"),t=document.getElementById("fullscreenToggle");i.style.display="none",e.style.display="none",t.style.display="none",te();const n=document.getElementById("fullscreenToast");n.textContent=se("Interface hidden - Press ESC to show interface"),n.classList.add("show"),z&&clearTimeout(z),z=setTimeout(()=>{n.classList.remove("show")},3e3)}async function ze(){if(window.__TAURI__)g?b?(console.log("Toggling interface visibility instead of exiting fullscreen (was fullscreen before)"),h?(oe(),h=!1):(ne(),h=!0)):(console.log("Exiting fullscreen (was not fullscreen before)"),g=!1,b=!1,we=!0,h=!1,await ae(),X(),a("isFullscreen",g),setTimeout(()=>{Y()},500)):(console.log("Entering fullscreen (was fullscreen before:",g,")"),b=g,g=!0,we=!0,h=!1,await Fe(),X(),a("isFullscreen",g));else if(!g)b=g,await Fe();else if(b){Ae();return}else await ae(),b=!1,h=!1,setTimeout(()=>{Y()},500)}function X(){const i=g;window.__TAURI__||(g=!!(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement));const e=document.getElementById("sidebar"),t=document.getElementById("sidebarToggle"),n=document.getElementById("fullscreenToggle"),o=document.getElementById("mobileFullscreenExit");if(g){if(e.style.display="none",t.style.display="none",n.style.display="none",o.classList.add("show"),i||te(),!i){const s=document.getElementById("fullscreenToast"),u=window.matchMedia("(hover: none) and (pointer: coarse)").matches;b?s.textContent=u?"Fullscreen mode - Tap ✕ at the top-right of this screen to toggle menu":"Fullscreen mode - Press ESC to toggle menu":s.textContent=u?"Fullscreen mode - Tap ✕ at the top-right of this screen to exit fullscreen":"Fullscreen mode - Press ESC to exit fullscreen",Ae()}}else{e.style.display="flex",t.style.display="flex",n.style.display="flex",n.textContent="⛶",n.title="Toggle Fullscreen",o.classList.remove("show"),i&&(_&&(clearTimeout(_),_=null),Te());const s=document.getElementById("fullscreenToast");s.classList.remove("show"),s.textContent=se("Press ESC to exit fullscreen")}}let L;const yt="SpiralPrefs",wt=1,U="preferences";function bt(){const i=indexedDB.open(yt,wt);i.onerror=()=>console.warn("IndexedDB not available"),i.onsuccess=e=>{L=e.target.result,window.db=L,Et(),window.__TAURI__&&setTimeout(()=>{Ce()},200)},i.onupgradeneeded=e=>{L=e.target.result,window.db=L,L.createObjectStore(U,{keyPath:"id"})}}function a(i,e){if(!L)return;L.transaction([U],"readwrite").objectStore(U).put({id:i,value:e})}window.db=null;window.savePreference=a;async function Y(){if(window.__TAURI__)try{const i=window.__TAURI__.window.getCurrentWindow(),e=await i.innerSize(),t=await i.innerPosition(),n=await i.isMaximized();g?console.log("Skipping window size save (in fullscreen mode)"):(a("windowWidth",e.width),a("windowHeight",e.height),a("windowX",t.x),a("windowY",t.y),a("windowMaximized",n),console.log("Window state saved:",{width:e.width,height:e.height,fullscreen:g})),a("isFullscreen",g)}catch(i){console.error("Failed to save window state:",i)}}async function Ce(){if(!window.__TAURI__||!L){console.log("Skipping window state load - Tauri not available or DB not ready");return}console.log("Loading window state...");try{const i=window.__TAURI__.window.getCurrentWindow();await new Promise(f=>setTimeout(f,100));const t=L.transaction([U],"readonly").objectStore(U),n=f=>new Promise(w=>{const y=t.get(f);y.onsuccess=()=>{var E;return w((E=y.result)==null?void 0:E.value)},y.onerror=()=>w(null)}),[o,s,u,m,l,v]=await Promise.all([n("windowWidth"),n("windowHeight"),n("windowX"),n("windowY"),n("windowMaximized"),n("isFullscreen")]);if(console.log("Loaded window state:",{width:o,height:s,x:u,y:m,maximized:l,fullscreen:v}),o&&s&&o>200&&s>200)if(o<=3840&&s<=2160)try{await i.setSize(new window.__TAURI__.window.LogicalSize(o,s)),console.log("✅ Window size restored:",o,"x",s)}catch(y){console.error("❌ Failed to restore window size:",y)}else console.log("❌ Saved window size too large, skipping restore:",o,"x",s),a("windowWidth",null),a("windowHeight",null);else console.log("❌ No valid window size to restore");if(u!==null&&m!==null&&u>=-1e3&&m>=-1e3)try{await i.setPosition(new window.__TAURI__.window.LogicalPosition(u,m)),console.log("✅ Window position restored:",u,",",m)}catch(f){console.error("❌ Failed to restore window position:",f)}else console.log("❌ No valid window position to restore");if(l)try{await i.maximize(),console.log("✅ Window maximized state restored")}catch(f){console.error("❌ Failed to restore maximized state:",f)}v&&setTimeout(async()=>{try{console.log("⚠️  Restoring fullscreen state..."),!1||(console.log("⏭️  Skipping fullscreen restoration (disabled for development)"),g=!1,b=!1,h=!1,a("isFullscreen",!1))}catch(f){console.error("❌ Failed to restore fullscreen state:",f),g=!1,b=!1,h=!1,a("isFullscreen",!1)}},300)}catch(i){console.error("❌ Failed to load window state:",i)}}function Et(){if(!L)return;const e=L.transaction([U],"readonly").objectStore(U);e.get("sidebarCollapsed").onsuccess=t=>{if(t.target.result){const n=document.getElementById("sidebar"),o=document.getElementById("sidebarToggle");t.target.result.value?(n.classList.add("collapsed"),T(o,"☰"),o.setAttribute("aria-expanded","false")):(T(o,"✕"),o.setAttribute("aria-expanded","true"))}else{const n=document.getElementById("sidebarToggle");T(n,"✕"),n.setAttribute("aria-expanded","true")}},e.get("spiralCoeff").onsuccess=t=>{if(t.target.result&&t.target.result.value!==void 0){const n=parseFloat(t.target.result.value);!isNaN(n)&&isFinite(n)&&n>0?(r=n,document.getElementById("spiralSlider").value=r,document.getElementById("spiralNumber").value=r,B()):(console.warn("Invalid spiralCoeff value loaded, resetting to default (2)"),r=2,document.getElementById("spiralSlider").value=r,document.getElementById("spiralNumber").value=r,a("spiralCoeff",r),B())}},e.get("maxN").onsuccess=t=>{t.target.result&&(k=t.target.result.value,document.getElementById("maxNSlider").value=k,document.getElementById("maxNNumber").value=k,B())},e.get("clusterCount").onsuccess=t=>{t.target.result&&(K=t.target.result.value,document.getElementById("clusterCountSlider").value=K,document.getElementById("clusterCountNumber").value=K,Ne())},e.get("showPrimes").onsuccess=t=>{if(t.target.result!==void 0){F=t.target.result.value;const n=document.getElementById("primeToggle");n.classList.toggle("active",F),n.setAttribute("aria-checked",F.toString()),T(n,F?"Defocus Prime Numbers":"Focus Prime Numbers")}},e.get("showClusters").onsuccess=t=>{if(t.target.result!==void 0){P=t.target.result.value;const n=document.getElementById("clusterToggle");n.classList.toggle("active",P),n.setAttribute("aria-checked",P.toString()),T(n,P?"Stop Animation":"Start Animation")}},e.get("showRotation").onsuccess=t=>{if(t.target.result!==void 0){A=t.target.result.value;const n=document.getElementById("rotationToggle");n.classList.toggle("active",A),n.setAttribute("aria-checked",A.toString()),T(n,A?"Stop Rotation":"Start Rotation")}},e.get("rotationSpeed").onsuccess=t=>{t.target.result&&(H=t.target.result.value,document.getElementById("rotationSpeedSlider").value=H,document.getElementById("rotationSpeedNumber").value=H)},e.get("useSquares").onsuccess=t=>{if(t.target.result!==void 0){M=t.target.result.value;const n=document.getElementById("shapeToggle");n.classList.toggle("active",M),n.setAttribute("aria-checked",M.toString()),T(n,M?"Use Circles":"Use Squares")}},e.get("instantRender").onsuccess=t=>{if(t.target.result!==void 0){x=t.target.result.value;const n=document.getElementById("instantRenderToggle");n.classList.toggle("active",x),n.setAttribute("aria-checked",x.toString()),T(n,x?"Disable Instant Render":"Enable Instant Render")}},e.get("dotSize").onsuccess=t=>{t.target.result&&(j=t.target.result.value,document.getElementById("dotSizeSlider").value=j,document.getElementById("dotSizeNumber").value=j)},e.get("primeSize").onsuccess=t=>{t.target.result&&(O=t.target.result.value,document.getElementById("primeSizeSlider").value=O,document.getElementById("primeSizeNumber").value=O)},e.get("scale").onsuccess=t=>{t.target.result&&(ie=t.target.result.value,B())},e.get("animateSpiralCoeff").onsuccess=t=>{if(t.target.result!==void 0){I=t.target.result.value;const n=document.getElementById("spiralAnimationToggle");n.classList.toggle("active",I),n.setAttribute("aria-checked",I.toString()),T(n,I?"Stop Spiral Animation":"Animate Spiral Coefficient");const o=document.getElementById("spiralAnimationControls");o.style.display=I?"block":"none",I&&xe()}},e.get("spiralAnimationSpeed").onsuccess=t=>{if(t.target.result&&t.target.result.value!==void 0){const n=parseInt(t.target.result.value);!isNaN(n)&&isFinite(n)&&n>=10&&n<=2e3?(W=n,document.getElementById("spiralAnimationSpeedSlider").value=W,document.getElementById("spiralAnimationSpeedNumber").value=W):(console.warn("Invalid spiralAnimationSpeed value, using default (100)"),W=100)}},e.get("spiralAnimationIncrement").onsuccess=t=>{if(t.target.result&&t.target.result.value!==void 0){const n=parseFloat(t.target.result.value);!isNaN(n)&&isFinite(n)&&n>0&&n<=10?(N=n,document.getElementById("spiralAnimationIncrementSlider").value=N,document.getElementById("spiralAnimationIncrementNumber").value=N):(console.warn("Invalid spiralAnimationIncrement value, using default (0.1)"),N=.1)}},e.get("spiralAnimationMin").onsuccess=t=>{if(t.target.result&&t.target.result.value!==void 0){const n=parseFloat(t.target.result.value);!isNaN(n)&&isFinite(n)&&n>0?(c=n,document.getElementById("spiralAnimationMinSlider").value=c,document.getElementById("spiralAnimationMinNumber").value=c):(console.warn("Invalid spiralAnimationMin value, using default (1)"),c=1)}},e.get("spiralAnimationMax").onsuccess=t=>{if(t.target.result&&t.target.result.value!==void 0){const n=parseFloat(t.target.result.value);!isNaN(n)&&isFinite(n)&&n>c?(d=n,document.getElementById("spiralAnimationMaxSlider").value=d,document.getElementById("spiralAnimationMaxNumber").value=d):(console.warn("Invalid spiralAnimationMax value, using default (500)"),d=500)}}}const Z=new Map;function Pe(i){if(Z.has(i))return Z.get(i);if(i<2)return Z.set(i,!1),!1;if(i===2)return Z.set(i,!0),!0;if(i%2===0)return Z.set(i,!1),!1;for(let e=3;e*e<=i;e+=2)if(i%e===0)return Z.set(i,!1),!1;return Z.set(i,!0),!0}function De(){C.width=window.innerWidth,C.height=window.innerHeight,B(),Ne()}function B(){const i=C.width,e=C.height,t=i/2,n=e/2;q=[],window.currentComputationId&&(cancelIdleCallback(window.currentComputationId),window.currentComputationId=null);const o=Math.min(k,2e6),u=Math.sqrt(i*i+e*e)/2;if(x){for(let l=1;l<=o;l++){const v=Math.sqrt(l)*ie,f=r*Math.PI*Math.sqrt(l),w=t+v*Math.cos(f),y=n+v*Math.sin(f),E=A?u:0;w<-E||w>i+E||y<-E||y>e+E||q.push({x:w,y,n:l,isPrime:Pe(l)})}k>o&&console.warn(`Capped point calculation at ${o} for performance`)}else{let f=function(){const w=Math.min(v+1e3,o);for(let y=v;y<=w;y++){const E=Math.sqrt(y)*ie,V=r*Math.PI*Math.sqrt(y),D=t+E*Math.cos(V),G=n+E*Math.sin(V),Q=A?u:0;D<-Q||D>i+Q||G<-Q||G>e+Q||q.push({x:D,y:G,n:y,isPrime:Pe(y)})}v=w+1,v<=o?window.currentComputationId=requestIdleCallback(f,{timeout:50}):(window.currentComputationId=null,k>o&&console.warn(`Capped point calculation at ${o} for performance`))};var m=f;let v=1;window.currentComputationId=requestIdleCallback(f,{timeout:50})}ht()}function Ne(){Ee.length=0;const i=C.width,e=C.height,t=Math.min(K,1e3);for(let n=0;n<t;n++){const o=Math.random()*i,s=Math.random()*e;Ee.push({x:o,y:s,targetX:Math.random()*i,targetY:Math.random()*e,speed:2+Math.random()*1})}K>t&&console.warn(`Capped cluster count at ${t} for performance`)}function St(){const i=C.width,e=C.height;Ee.forEach(t=>{const n=t.targetX-t.x,o=t.targetY-t.y,s=Math.hypot(n,o);s<t.speed?(t.targetX=Math.random()*i,t.targetY=Math.random()*e):(t.x+=n/s*t.speed,t.y+=o/s*t.speed)})}function qe(){P&&St(),A&&(ke+=H*.01),S.fillStyle=`rgba(0,0,0,${ft})`,S.fillRect(0,0,C.width,C.height),S.save(),A&&(S.translate(C.width/2,C.height/2),S.rotate(ke),S.translate(-C.width/2,-C.height/2));let i;x||q.length<=1e4?i=q.length:q.length<=5e4?i=Math.min(q.length,2e3):i=Math.min(q.length,5e3);const e=[],t=[];for(let n=0;n<i;n++){const o=q[n%q.length];let s=0;if(P)for(const f of Ee){const w=o.x-f.x,y=o.y-f.y;if(Math.abs(w)<ye&&Math.abs(y)<ye){const E=1-Math.abs(w)/ye,V=1-Math.abs(y)/ye,D=Math.min(E,V);s=Math.max(s,D)}}let u=j;F&&o.isPrime&&(u*=O);const m=u+s*mt,l=-s*pt,v={...o,size:m,offsetY:l};F&&o.isPrime?e.push(v):t.push(v)}t.length>0&&(S.fillStyle="#009900",t.forEach(n=>{M?S.fillRect(n.x-n.size/2,n.y+n.offsetY-n.size/2,n.size,n.size):(S.beginPath(),S.arc(n.x,n.y+n.offsetY,n.size/2,0,2*Math.PI),S.fill())})),e.length>0&&(S.fillStyle="#00ff00",e.forEach(n=>{M?S.fillRect(n.x-n.size/2,n.y+n.offsetY-n.size/2,n.size,n.size):(S.beginPath(),S.arc(n.x,n.y+n.offsetY,n.size/2,0,2*Math.PI),S.fill())})),S.restore(),requestAnimationFrame(qe)}function Tt(i,e,t){return Math.max(e,Math.min(t,i))}const xt=re(i=>a("scale",i),200);window.addEventListener("wheel",i=>{i.preventDefault();const e=ie*(i.deltaY>0?1.1:.9);console.log("velocity:",e),ie=Tt(e,2,200),xt(ie),x?B():ve()},{passive:!1});const It=document.getElementById("sidebar");It.addEventListener("wheel",i=>{i.stopPropagation()},{passive:!0});const $e=document.getElementById("fullscreenToggle");$e.addEventListener("click",ze);const Se=document.getElementById("mobileFullscreenExit");Se.addEventListener("click",()=>{g&&(window.__TAURI__?b?h?(oe(),h=!1):(ne(),h=!0):(g=!1,b=!1,we=!0,h=!1,ae(),X(),a("isFullscreen",g),setTimeout(()=>{Y()},500)):b?h?(oe(),h=!1):(ne(),h=!0):(g=!1,ae(),X(),b=!1,h=!1,setTimeout(()=>{Y()},500)))});Se.addEventListener("touchstart",i=>{i.preventDefault()},{passive:!1});Se.addEventListener("touchend",i=>{i.preventDefault(),Se.click()},{passive:!1});document.addEventListener("fullscreenchange",X);document.addEventListener("webkitfullscreenchange",X);document.addEventListener("msfullscreenchange",X);C.addEventListener("click",()=>{g&&Ae()});const ee=document.getElementById("sidebar"),$=document.getElementById("sidebarToggle");$.addEventListener("click",()=>{const i=ee.classList.toggle("collapsed"),e=document.getElementById("fullscreenToggle");if(T($,i?"☰":"✕"),$.setAttribute("aria-expanded",(!i).toString()),a("sidebarCollapsed",i),window.innerWidth>=768)if(i){ee.style.display="none",$.style.display="none",e.style.display="none";const t=document.getElementById("fullscreenToast");t.textContent=se("Sidebar hidden - Press S to reopen"),t.classList.add("show"),z&&clearTimeout(z),z=setTimeout(()=>{t.classList.remove("show"),t.textContent=se("Press ESC to exit fullscreen")},3e3)}else ee.style.display="flex",$.style.display="flex",e.style.display="flex"});const ce=document.getElementById("primeToggle");ce.addEventListener("click",()=>{F=!F,ce.classList.toggle("active",F),ce.setAttribute("aria-checked",F.toString()),T(ce,F?"Defocus Prime Numbers":"Focus Prime Numbers"),R(`Prime number highlighting ${F?"enabled":"disabled"}`),a("showPrimes",F)});const ue=document.getElementById("clusterToggle");ue.addEventListener("click",()=>{P=!P,ue.classList.toggle("active",P),ue.setAttribute("aria-checked",P.toString()),T(ue,P?"Stop Animation":"Start Animation"),a("showClusters",P)});const de=document.getElementById("rotationToggle");de.addEventListener("click",()=>{A=!A,de.classList.toggle("active",A),de.setAttribute("aria-checked",A.toString()),T(de,A?"Stop Rotation":"Start Rotation"),R(`Spiral rotation ${A?"started":"stopped"}`),a("showRotation",A),B()});const me=document.getElementById("shapeToggle");me.addEventListener("click",()=>{M=!M,me.classList.toggle("active",M),me.setAttribute("aria-checked",M.toString()),T(me,M?"Use Circles":"Use Squares"),a("useSquares",M)});const pe=document.getElementById("instantRenderToggle");pe.addEventListener("click",()=>{x=!x,pe.classList.toggle("active",x),pe.setAttribute("aria-checked",x.toString()),T(pe,x?"Disable Instant Render":"Enable Instant Render"),a("instantRender",x)});function xe(){ge||(ge=setInterval(()=>{(isNaN(r)||!isFinite(r))&&(r=2),(isNaN(N)||!isFinite(N)||N<=0)&&(N=.1),(isNaN(c)||!isFinite(c)||c<=0)&&(c=1),(isNaN(d)||!isFinite(d)||d<=c)&&(d=500);const i=r+N*Be;isNaN(i)||!isFinite(i)?(console.warn("Invalid spiral coefficient calculated, resetting to safe value"),r=Ie(2,c,d)):r=i,(r<=c||r>=d)&&(Be*=-1,r=Ie(r,c,d)),document.getElementById("spiralSlider").value=r,document.getElementById("spiralNumber").value=r,a("spiralCoeff",r),B()},W))}function Le(){ge&&(clearInterval(ge),ge=null)}const fe=document.getElementById("spiralAnimationToggle");fe.addEventListener("click",()=>{I=!I,fe.classList.toggle("active",I),fe.setAttribute("aria-checked",I.toString()),T(fe,I?"Stop Spiral Animation":"Animate Spiral Coefficient");const i=document.getElementById("spiralAnimationControls");i.style.display=I?"block":"none",I?xe():Le(),a("animateSpiralCoeff",I)});const We=document.getElementById("spiralAnimationSpeedSlider"),Ke=document.getElementById("spiralAnimationSpeedNumber");We.addEventListener("input",i=>{W=parseInt(i.target.value),Ke.value=W,a("spiralAnimationSpeed",W),I&&(Le(),xe())});Ke.addEventListener("input",i=>{const e=parseInt(i.target.value);e>=50&&e<=500&&!isNaN(e)&&(W=e,e>=100&&e<=500&&(We.value=W),a("spiralAnimationSpeed",W),I&&(Le(),xe()))});const Ue=document.getElementById("spiralAnimationIncrementSlider"),He=document.getElementById("spiralAnimationIncrementNumber");Ue.addEventListener("input",i=>{N=parseFloat(i.target.value),He.value=N,a("spiralAnimationIncrement",N)});He.addEventListener("input",i=>{const e=parseFloat(i.target.value);e>=.01&&e<=10&&!isNaN(e)&&(N=e,e>=.01&&e<=2&&(Ue.value=N),a("spiralAnimationIncrement",N))});const je=document.getElementById("spiralAnimationMinSlider"),Oe=document.getElementById("spiralAnimationMinNumber");je.addEventListener("input",i=>{c=parseFloat(i.target.value),Oe.value=c,a("spiralAnimationMin",c),c>=d&&(d=c+10,document.getElementById("spiralAnimationMaxSlider").value=d,document.getElementById("spiralAnimationMaxNumber").value=d,a("spiralAnimationMax",d))});Oe.addEventListener("input",i=>{const e=parseFloat(i.target.value);e>=.1&&e<=1e3&&!isNaN(e)&&(c=e,e>=.1&&e<=100&&(je.value=c),a("spiralAnimationMin",c),c>=d&&(d=c+10,document.getElementById("spiralAnimationMaxSlider").value=d,document.getElementById("spiralAnimationMaxNumber").value=d,a("spiralAnimationMax",d)))});const Ve=document.getElementById("spiralAnimationMaxSlider"),Ye=document.getElementById("spiralAnimationMaxNumber");Ve.addEventListener("input",i=>{d=parseFloat(i.target.value),Ye.value=d,a("spiralAnimationMax",d),d<=c&&(c=Math.max(.1,d-10),document.getElementById("spiralAnimationMinSlider").value=c,document.getElementById("spiralAnimationMinNumber").value=c,a("spiralAnimationMin",c))});Ye.addEventListener("input",i=>{const e=parseFloat(i.target.value);e>=10&&e<=2e3&&!isNaN(e)&&(d=e,e>=10&&e<=1e3&&(Ve.value=d),a("spiralAnimationMax",d),d<=c&&(c=Math.max(.1,d-10),document.getElementById("spiralAnimationMinSlider").value=c,document.getElementById("spiralAnimationMinNumber").value=c,a("spiralAnimationMin",c)))});function Ie(i,e,t){return Math.max(e,Math.min(t,i))}function At(){const i=document.getElementById("spiralAnimationMinNumber"),e=document.getElementById("spiralAnimationMaxNumber"),t=parseFloat(i.value),n=parseFloat(e.value);!isNaN(t)&&isFinite(t)&&t>0?c=t:(c=1,i.value=c),!isNaN(n)&&isFinite(n)&&n>c?d=n:(d=Math.max(500,c+10),e.value=d),(isNaN(r)||!isFinite(r))&&(r=2),r=Ie(r,c,d),document.getElementById("spiralSlider").value=r,document.getElementById("spiralNumber").value=r,a("spiralCoeff",r),a("spiralAnimationMin",c),a("spiralAnimationMax",d)}function Ct(){const i=document.getElementById("spiralAnimationMinNumber"),e=document.getElementById("spiralAnimationMaxNumber");i.value=c=parseFloat(Me("spiralAnimationMin",1)),e.value=d=parseFloat(Me("spiralAnimationMax",500)),At()}function Me(i,e){if(!L)return e;const n=L.transaction([U],"readonly").objectStore(U);return new Promise(o=>{const s=n.get(i);s.onsuccess=()=>{var u;return o(((u=s.result)==null?void 0:u.value)||e)},s.onerror=()=>o(e)})}window.addEventListener("load",()=>{Ct()});function re(i,e){let t;return function(...o){const s=()=>{clearTimeout(t),i(...o)};clearTimeout(t),t=setTimeout(s,e)}}const ve=re(B,100),Xe=re(Ne,100),Ge=document.getElementById("spiralSlider"),Je=document.getElementById("spiralNumber"),Nt=re(i=>{R(`Spiral coefficient: ${i}`)},500);Ge.addEventListener("input",i=>{if(!Re())return;const e=he.validateNumber(parseFloat(i.target.value),2,200,r);r=e,Je.value=r,a("spiralCoeff",r),Nt(e.toFixed(1)),x?B():ve()});Je.addEventListener("input",i=>{if(!Re())return;const e=he.validateNumber(parseFloat(i.target.value),0,2e3,r);if(isNaN(e)||e<0||e>2e3){R("Invalid spiral coefficient value. Please enter a number between 0 and 2000.",!0);return}r=e,e>=2&&e<=200&&(Ge.value=r),a("spiralCoeff",r),x?B():ve()});const Qe=document.getElementById("maxNSlider"),Ze=document.getElementById("maxNNumber"),Lt=re(i=>{const e=i.toLocaleString();R(`Point count: ${e}`)},500);Qe.addEventListener("input",i=>{k=parseInt(i.target.value),Ze.value=k,a("maxN",k),Lt(k),x?B():ve()});Ze.addEventListener("input",i=>{const e=parseInt(i.target.value);e>=1&&e<=19e5&&!isNaN(e)?(k=e,e>=500&&e<=19e4&&(Qe.value=k),e>5e5&&(console.warn(`Warning: Using ${e} points may impact performance`),R(`Warning: ${e.toLocaleString()} points may impact performance`,!0)),a("maxN",k),x?B():ve()):R("Invalid point count. Please enter a number between 1 and 1,900,000.",!0)});const et=document.getElementById("clusterCountSlider"),tt=document.getElementById("clusterCountNumber");et.addEventListener("input",i=>{K=parseInt(i.target.value),tt.value=K,a("clusterCount",K),Xe()});tt.addEventListener("input",i=>{const e=parseInt(i.target.value);e>=0&&e<=2e3&&!isNaN(e)&&(K=e,e>=100&&e<=200&&(et.value=K),e>500&&console.warn(`Warning: Using ${e} clusters may impact performance`),a("clusterCount",K),Xe())});const it=document.getElementById("rotationSpeedSlider"),nt=document.getElementById("rotationSpeedNumber");it.addEventListener("input",i=>{H=parseFloat(i.target.value),nt.value=H,a("rotationSpeed",H)});nt.addEventListener("input",i=>{const e=parseFloat(i.target.value);e>=.1&&e<=10&&!isNaN(e)&&(H=e,e>=.1&&e<=5&&(it.value=H),a("rotationSpeed",H))});const ot=document.getElementById("dotSizeSlider"),st=document.getElementById("dotSizeNumber");ot.addEventListener("input",i=>{j=parseFloat(i.target.value),st.value=j,a("dotSize",j)});st.addEventListener("input",i=>{const e=parseFloat(i.target.value);e>=.1&&e<=20&&!isNaN(e)&&(j=e,e>=.5&&e<=10&&(ot.value=j),a("dotSize",j))});const at=document.getElementById("primeSizeSlider"),lt=document.getElementById("primeSizeNumber");at.addEventListener("input",i=>{O=parseFloat(i.target.value),lt.value=O,a("primeSize",O)});lt.addEventListener("input",i=>{const e=parseFloat(i.target.value);e>=.1&&e<=10&&!isNaN(e)&&(O=e,e>=.5&&e<=5&&(at.value=O),a("primeSize",O))});document.getElementById("spiralCanvas").addEventListener("click",()=>{$.click()});document.addEventListener("keydown",i=>{te(),!(i.target.tagName==="INPUT"||i.target.tagName==="TEXTAREA")&&(i.key==="Escape"&&(g?window.__TAURI__?b?(console.log("ESC: Toggling interface visibility in fullscreen (was fullscreen before)"),h?(oe(),h=!1):(ne(),h=!0)):(console.log("ESC: Exiting fullscreen"),g=!1,b=!1,we=!0,h=!1,ae(),X(),a("isFullscreen",g),setTimeout(()=>{Y()},500)):b?h?(oe(),h=!1):(ne(),h=!0):(g=!1,ae(),X(),b=!1,h=!1,setTimeout(()=>{Y()},500)):ee.classList.contains("collapsed")||$.click()),(i.key==="F11"||i.key==="f"&&!i.ctrlKey&&!i.metaKey)&&(i.preventDefault(),g&&b?(console.log("F key: Toggling interface visibility in fullscreen (was fullscreen before)"),h?(oe(),h=!1):(ne(),h=!0)):ze()),i.key==="s"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),window.innerWidth>=768&&ee.style.display==="none"?(ee.style.display="flex",$.style.display="flex",$e.style.display="flex",ee.classList.remove("collapsed"),T($,"✕"),$.setAttribute("aria-expanded","true"),a("sidebarCollapsed",!1)):$.click()),i.key==="p"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),ce.click()),i.key==="a"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),ue.click()),i.key==="r"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),de.click()),i.key==="c"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),me.click()),i.key==="i"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),pe.click()),i.key==="m"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),fe.click()),i.key==="h"&&!i.ctrlKey&&!i.metaKey&&(i.preventDefault(),p&&p.triggerManually()))});typeof window<"u"&&(window.debugTutorial={async checkStatus(){if(!p){console.log("Tutorial manager not available");return}const i=await p.hasBeenSkipped(),e=await p.hasBeenCompleted(),t=await p.getTutorialPreference("started"),n=await p.getTutorialPreference("manualTrigger");console.log("Tutorial Status:",{skipped:i,completed:e,started:t?new Date(t):null,manualTrigger:n,isCurrentlyActive:p.isActive})},async reset(){if(!p){console.log("Tutorial manager not available");return}await p.resetTutorialState()},async trigger(){if(!p){console.log("Tutorial manager not available");return}await p.triggerManually()}},console.log("Tutorial debugging available: debugTutorial.checkStatus(), debugTutorial.reset(), debugTutorial.trigger()"));document.addEventListener("mousemove",te);document.addEventListener("click",te);document.addEventListener("mousedown",te);window.addEventListener("resize",De);window.addEventListener("load",()=>{document.body&&(document.body.tabIndex=-1,document.body.focus()),window.__TAURI__&&setTimeout(()=>{console.log("Attempting window state restore from window load event..."),Ce()},500)});if(window.__TAURI__){const i=re(Y,500);window.addEventListener("resize",i),window.addEventListener("focus",i),window.addEventListener("blur",i),window.addEventListener("beforeunload",()=>{Y()}),window.debugSaveWindowState=Y,window.debugLoadWindowState=Ce,console.log("Tauri window state persistence enabled"),console.log("Debug commands available: debugSaveWindowState(), debugLoadWindowState()")}let J=!0;function T(i,e){const t=i.querySelector(".tooltip"),n=i.querySelector(".tooltip-icon"),o=[];t&&o.push(t),n&&o.push(n),o.forEach(s=>s.remove()),i.textContent=he.sanitizeText(e),o.forEach(s=>i.appendChild(s))}function le(){document.querySelectorAll(".tooltip.show").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".tooltip-icon").forEach(e=>{e._tapTimeout&&(clearTimeout(e._tapTimeout),e._tapTimeout=null)})}document.addEventListener("click",le);document.addEventListener("touchend",le,{passive:!0});function kt(i,e){if(!e)return;const t=document.createElement("div");t.className="tooltip bottom",t.textContent=e,i.appendChild(t);const n=document.createElement("div");n.className="tooltip-icon",n.textContent="i",i.appendChild(n);function o(){if(!J)return;console.log("Positioning tooltip for:",e);const l=i.getBoundingClientRect(),v=t.getBoundingClientRect(),f=window.innerHeight;t.className="tooltip",window.matchMedia("(hover: none) and (pointer: coarse)").matches?t.classList.add("bottom"):l.top>v.height+10?t.classList.add("top"):l.bottom+v.height+10<f?t.classList.add("bottom"):l.left>v.width+10?t.classList.add("left"):t.classList.add("right"),console.log("Tooltip positioned with class:",t.className)}let s;function u(){J&&(console.log("Showing tooltip for:",e),le(),o(),t.classList.add("show"),s&&clearTimeout(s),n._tapTimeout=s,s=setTimeout(()=>{t.classList.remove("show"),n._tapTimeout=null},4e3))}n.addEventListener("touchstart",l=>{l.stopPropagation(),l.preventDefault()},{passive:!1}),n.addEventListener("touchend",l=>{l.stopPropagation(),l.preventDefault(),u()},{passive:!1}),n.addEventListener("click",l=>{l.stopPropagation(),l.preventDefault(),u()}),i.classList.contains("toggle-button")&&i.addEventListener("click",l=>{l.stopPropagation()});let m;i.addEventListener("mouseenter",l=>{J&&(l.stopPropagation(),m=setTimeout(()=>{le(),o(),t.classList.add("show")},500))}),i.addEventListener("mouseleave",l=>{l.stopPropagation(),m&&clearTimeout(m),t.classList.remove("show")})}function Bt(){const i=document.querySelectorAll("[data-tooltip]");console.log("Initializing tooltips for",i.length,"elements"),i.forEach((t,n)=>{const o=t.getAttribute("data-tooltip");console.log(`Creating tooltip ${n+1}:`,o),kt(t,o)});const e=window.matchMedia("(hover: none) and (pointer: coarse)").matches;console.log("Mobile device detected:",e)}function _e(){const i=document.body;J?i.classList.remove("tooltips-disabled"):(i.classList.add("tooltips-disabled"),le())}function Ft(){const i=document.getElementById("disableTooltips");if(i){if(L){const t=L.transaction([U],"readonly").objectStore(U);t.get("tooltipsEnabled").onsuccess=n=>{n.target.result!==void 0&&(J=n.target.result.value,i.checked=!J,_e())}}i.addEventListener("change",e=>{J=!e.target.checked,_e(),a("tooltipsEnabled",J)})}}function Pt(){try{p=new ct;const i=document.getElementById("tutorialLink");i&&i.addEventListener("click",e=>{e.preventDefault(),p&&p.triggerManually()}),setTimeout(async()=>{if(p)try{await p.shouldShowTutorial()&&setTimeout(()=>{p.start(!1)},1e3)}catch(e){console.warn("Failed to check tutorial status:",e)}},500),window.tutorialManager=p,window.startTutorial=()=>p==null?void 0:p.start(!0),window.resetTutorial=()=>p==null?void 0:p.reset(),window.forceResetTutorial=()=>p==null?void 0:p.forceReset(),window.getTutorialStats=()=>p==null?void 0:p.getStats(),console.log("Tutorial system initialized successfully")}catch(i){console.error("Failed to initialize tutorial system:",i)}}function Mt(){const i=document.getElementById("aboutLink"),e=document.getElementById("aboutModal"),t=document.getElementById("aboutModalClose");if(!i||!e||!t)return;function n(){return e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')}function o(l){const v=n(),f=v[0],w=v[v.length-1];l.key==="Tab"&&(l.shiftKey?document.activeElement===f&&(l.preventDefault(),w.focus()):document.activeElement===w&&(l.preventDefault(),f.focus()))}function s(){e.classList.add("show"),e.setAttribute("aria-hidden","false"),t.focus(),document.body.style.overflow="hidden",document.addEventListener("keydown",o),R("About modal opened")}function u(){e.classList.remove("show"),e.setAttribute("aria-hidden","true"),document.body.style.overflow="hidden",i.focus(),document.removeEventListener("keydown",o),R("About modal closed")}i.addEventListener("click",l=>{l.preventDefault(),s()}),t.addEventListener("click",u),e.addEventListener("click",l=>{l.target===e&&u()}),document.addEventListener("keydown",l=>{l.key==="Escape"&&e.classList.contains("show")&&(l.stopPropagation(),u())});const m=le;window.closeAllTooltips=function(){m(),e.classList.contains("show")&&u()}}bt();De();requestAnimationFrame(qe);setTimeout(()=>{Bt(),Ft(),Mt(),Pt(),vt()},100);
